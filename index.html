<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jikan Manga Finder</title>
  <style>body{margin:0;font-family:sans-serif;background:#0b0d10;color:#e8eef6}.card{background:#12151a;border:1px solid #1d232d;border-radius:12px;padding:8px;cursor:pointer}.cover{width:100%;aspect-ratio:3/4;object-fit:cover}</style>
</head>
<body>
  <h2 style="padding:1rem">Jikan Manga Finder + MangaDex Reader</h2>
  <div id="results"></div>
  <dialog id="reader"><div id="pages"></div><button onclick="this.parentElement.close()">Close</button></dialog>

  <script>
    const results=document.getElementById("results");
    const reader=document.getElementById("reader");
    const pages=document.getElementById("pages");

    async function jikanTop(){
      const res=await fetch("https://api.jikan.moe/v4/top/manga?page=1");
      const data=await res.json();
      results.innerHTML="";
      data.data.forEach(m=>{
        const d=document.createElement("div");
        d.className="card";
        d.innerHTML=`<img class=cover src="${m.images.jpg.image_url}"/><div>${m.title}</div>`;
        d.onclick=()=>openReader(m.title);
        results.appendChild(d);
      });
    }

    async function mdGet(url){
      const res=await fetch("/api/mangadex?u="+encodeURIComponent(url));
      if(!res.ok) throw new Error("HTTP "+res.status);
      return res.json();
    }

    async function mdSearch(title){
      const url=`https://api.mangadex.org/manga?title=${encodeURIComponent(title)}&limit=1`;
      const d=await mdGet(url); return d.data[0];
    }

    async function mdChapters(mangaId){
      const url=`https://api.mangadex.org/chapter?manga=${mangaId}&limit=1&translatedLanguage[]=en&order[chapter]=asc`;
      const d=await mdGet(url); return d.data[0];
    }

    async function mdChapterDetail(id){ return (await mdGet(`https://api.mangadex.org/chapter/${id}`)).data; }
    async function mdAtHome(id){ return await mdGet(`https://api.mangadex.org/at-home/server/${id}`); }

    async function buildPageUrls(chId){
      const [detail, home]=await Promise.all([mdChapterDetail(chId), mdAtHome(chId)]);
      const hash=detail.attributes.hash;
      let files=[];
      if(detail.attributes.dataSaver && detail.attributes.dataSaver.length){ files=detail.attributes.dataSaver; }
      else if(detail.attributes.data && detail.attributes.data.length){ files=detail.attributes.data; }
      else throw new Error("No page files");
      const base=home.baseUrl+(files===detail.attributes.dataSaver?"/data-saver/":"/data/");
      return files.map(f=>base+hash+"/"+f);
    }

    async function openReader(title){
      try{
        const m=await mdSearch(title);
        const ch=await mdChapters(m.id);
        const urls=await buildPageUrls(ch.id);
        pages.innerHTML="";
        urls.forEach(u=>{const im=document.createElement("img"); im.src=u; im.style.width="100%"; im.loading="lazy"; pages.appendChild(im);});
        reader.showModal();
      }catch(e){alert("Gagal buka reader: "+e.message)}
    }

    jikanTop();
  </script>
</body>
</html>